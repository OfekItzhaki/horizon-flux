generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String                @id @default(uuid())
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  email                 String                @unique @db.VarChar(255)
  name                  String?               @db.VarChar(100)
  deletedAt             DateTime?
  profilePicture        String?               @db.VarChar(500)
  emailVerified         Boolean               @default(false)
  notificationFrequency NotificationFrequency @default(NONE)
  trashRetentionDays    Int                   @default(30)
  lists                 ToDoList[]
  shares                ListShare[]
  taskShares            TaskShare[]

  @@index([email])
}

model ToDoList {
  id               String           @id @default(uuid())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  name             String           @db.VarChar(255)
  ownerId          String
  order            Int              @default(autoincrement())
  deletedAt        DateTime?
  type             ListType         @default(CUSTOM)
  isSystem         Boolean          @default(false)
  taskBehavior     TaskBehavior     @default(ONE_OFF)
  completionPolicy CompletionPolicy @default(KEEP)
  shares           ListShare[]
  tasks            Task[]
  owner            User             @relation(fields: [ownerId], references: [id])
}

model ListShare {
  id           String    @id @default(uuid())
  sharedWithId String
  toDoListId   String
  role         ShareRole @default(EDITOR)
  toDoList     ToDoList  @relation(fields: [toDoListId], references: [id])
  sharedWith   User      @relation(fields: [sharedWithId], references: [id])

  @@unique([sharedWithId, toDoListId])
}

model Task {
  id                 String      @id @default(uuid())
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  description        String      @db.VarChar(255)
  completed          Boolean     @default(false)
  completedAt        DateTime?
  completionCount    Int         @default(0)
  todoListId         String
  originalListId     String?
  order              Int         @default(autoincrement())
  deletedAt          DateTime?
  dueDate            DateTime?
  reminderDaysBefore Int[]       @default([1])
  specificDayOfWeek  Int?
  reminderConfig     Json?
  steps              Step[]
  todoList           ToDoList    @relation(fields: [todoListId], references: [id])
  shares             TaskShare[]
}

model Step {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  description String
  completed   Boolean   @default(false)
  taskId      String
  order       Int       @default(autoincrement())
  deletedAt   DateTime?
  task        Task      @relation(fields: [taskId], references: [id])
}

model TaskShare {
  id           String    @id @default(uuid())
  sharedWithId String
  taskId       String
  role         ShareRole @default(EDITOR)
  task         Task      @relation(fields: [taskId], references: [id])
  sharedWith   User      @relation(fields: [sharedWithId], references: [id])

  @@unique([sharedWithId, taskId])
}

enum NotificationFrequency {
  NONE
  DAILY
  WEEKLY
}

enum ShareRole {
  VIEWER
  EDITOR
}

enum ListType {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
  DONE     // System list for archived completed tasks
  TRASH    // System list for soft-deleted tasks
}

enum TaskBehavior {
  RECURRING
  ONE_OFF
}

enum CompletionPolicy {
  AUTO_DELETE
  KEEP
  MOVE_TO_DONE
}
